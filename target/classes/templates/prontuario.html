<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Médico</title>
    <link rel="stylesheet" href="/CSS/styleMedico/styleMedicoGenerico.css">
    <link rel="stylesheet" href="/CSS/styleMedico/styleProntuario.css">
</head>

<body>

<header style="box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);">
    <img src="/img/Logo.png" alt="Logo Saúde++" class="logo">
    <div class="perfil">
        <div class="perfil-info">
            <p>Nome do médico</p>
            <p>CRM: 345678987654</p>
            <p>Especialidade</p>
        </div>
        <img src="/img/iconMedico.png" alt="Foto do médico" class="perfil-foto" style="height: 50px;">
        <a href="/logout"><button class="logout">LOGOUT</button></a>
    </div>
</header>

<main>
    <div class="prontuarioPaciente">
        <h2>Prontuário do Paciente</h2>
        <p><strong>Nome:</strong> João Silva</p>
        <p><strong>Idade:</strong> 34 anos</p>
        <p><strong>Sexo:</strong> Masculino</p>
        <p><strong>CPF:</strong> 123.456.789-00</p>
        <p><strong>Endereço:</strong> Rua das Flores, 123 - São Paulo/SP</p>
        <p><strong>Telefone:</strong> (11) 98765-4321</p>
        <hr>
        <p><strong>Histórico Médico:</strong> Hipertensão, Alergia a dipirona</p>
        <p><strong>Medicamentos em uso:</strong> Losartana 50mg/dia</p>
        <p><strong>Última consulta:</strong> 10/08/2025</p>
        <p><strong>Observações:</strong> Recomendado acompanhamento trimestral</p>
    </div>

    <div class="botoes">
        <button type="button" id="consultarBtn" class="consultar iniciar-consulta">
            Consultar prontuários antigos
        </button>
        <button type="button" id="interpretarBtn" class="interpretar iniciar-consulta">
            Interpretar prontuário
        </button>

        <form id="pdfForm" enctype="multipart/form-data" style="margin:0;">
            <input type="file" id="pdfFile" name="file" accept="application/pdf" required>
        </form>

        <div id="respostaIA" class="resposta-ia"></div>
    </div>

    <!-- Overlay de loading -->
    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <!-- path corrected to /video (static resources are served from /video/*)
                 added id and preload to improve autoplay behavior and allow JS control -->
            <video id="loadingVideo" autoplay loop muted playsinline preload="auto">
                <source src="/video/icone_loading.mp4" type="video/mp4">
                Seu navegador não suporta vídeo.
            </video>
            <p>Gerando prontuário...</p>
        </div>
    </div>

    <a href="/medico" class="voltar-fixo"><button class="logout">voltar</button></a>
</main>

<!-- Script -->
<script>
document.getElementById('interpretarBtn').addEventListener('click', async function () {
    const form = document.getElementById('pdfForm');
    const fileInput = document.getElementById('pdfFile');
    const loading = document.getElementById('loading');
    const respostaDiv = document.getElementById('respostaIA');

    if (!fileInput.files.length) {
        alert('Selecione um arquivo PDF!');
        return;
    }

    loading.classList.add('active'); // ativa o overlay
    // Tenta garantir que o vídeo comece a tocar (autoplay funciona quando muted)
    const vid = document.getElementById('loadingVideo');
    if (vid) {
        vid.muted = true;
        vid.play().catch(() => {});
    }

    respostaDiv.textContent = '';
    const formData = new FormData(form);
    try {
        const response = await fetch('/api/interpretar-pdf', { method: 'POST', body: formData });
        const result = await response.json();

        let resposta = '';
        if (result.respostaIA) {
            try {
                const iaObj = JSON.parse(result.respostaIA);
                resposta = iaObj.resposta || result.respostaIA;
            } catch (e) {
                resposta = result.respostaIA;
            }
        } else if (result.erroIA) {
            resposta = result.erroIA;
        } else {
            resposta = 'Nenhuma resposta da IA.';
        }

        respostaDiv.textContent = resposta;
    } catch (err) {
        respostaDiv.textContent = 'Erro ao processar o arquivo.';
    } finally {
        // pausa/reset do vídeo quando fechar o overlay
        const vidClose = document.getElementById('loadingVideo');
        if (vidClose) { vidClose.pause(); vidClose.currentTime = 0; }
        loading.classList.remove('active'); // desativa o overlay
    }
});
</script>

</body>
</html>
